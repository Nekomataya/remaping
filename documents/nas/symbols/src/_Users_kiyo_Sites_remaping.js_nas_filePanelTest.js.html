<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="TOKN">﻿</span><span class="COMM">/** 
<span class='line'>  2</span>  * @fileoverview UAT　documentPanel
<span class='line'>  3</span>  *    サーバ対応ドキュメントパネル機能
<span class='line'>  4</span>  *    調整後はxUIに統合予定
<span class='line'>  5</span>  * @aouther kiyo@nekomataya.info (ねこまたや)
<span class='line'>  6</span>  * @version 0.9.1 20190221
<span class='line'>  7</span>  */</span><span class="WHIT">
<span class='line'>  8</span> </span><span class="COMM">/*
<span class='line'>  9</span> ドキュメントパネル自体が、データリストを保持する構造にする
<span class='line'> 10</span> 
<span class='line'> 11</span> 
<span class='line'> 12</span> 実際にデータを保持しているモジュールに対してリスト取得リクエストを出し、自分自身のデータリストを管理する
<span class='line'> 13</span> アプリケーション内の請求手続きは一種類にしてサービスエージェントを通してモジュール間の差異を吸収する
<span class='line'> 14</span> 
<span class='line'> 15</span> ローカルストレージを使用した参考リポジトリを設計実装する
<span class='line'> 16</span> （サービスモジュールのデフォルト値として登録する）
<span class='line'> 17</span> 
<span class='line'> 18</span> UI上のドキュメントパネルのオプションリストは、表示用のバッファとして利用（保持リスト本体ではない）
<span class='line'> 19</span> 
<span class='line'> 20</span> リストのソート タイトルソート・話数ソート・フィルタ等の補助機能を実装
<span class='line'> 21</span> カット番号リストは、ソートを基本　逆順表示　番号フィルタ　を設計実装
<span class='line'> 22</span> 
<span class='line'> 23</span> ドキュメントエントリは、SCiオブジェクトにサービスへの参照を拡張して使用
<span class='line'> 24</span> 
<span class='line'> 25</span> 
<span class='line'> 26</span>     serviceAgent.currentRepository
<span class='line'> 27</span> 
<span class='line'> 28</span> 現在使用しているリポジトリのリスト
<span class='line'> 29</span> サービスにアクセスするごとに更新
<span class='line'> 30</span> サービスエージェント上のエントリへの参照
<span class='line'> 31</span> 
<span class='line'> 32</span>     documentDepot.products
<span class='line'> 33</span> 
<span class='line'> 34</span> プロダクトコレクション　サービスにアクセスするごとに抽出更新
<span class='line'> 35</span> 各プロダクトは独立したデータとして一覧アクセスできるようにしておく
<span class='line'> 36</span> フィルタは、Depotのオブジェクトメソッドで実装
<span class='line'> 37</span> nas.Pm.Opus オブジェクトを使用　リポジトリへの参照を加える
<span class='line'> 38</span> opusが同じでもリポジトリが異なる場合は、同エントリ内で複数を保持
<span class='line'> 39</span> 
<span class='line'> 40</span> 空プロダクトを作成する際は、リポジトリ内に対応する　TITLE及びOPUSを同時に作成するようにトライする
<span class='line'> 41</span> 対応するオブジェクトが存在しないエントリは処理に失敗する
<span class='line'> 42</span> 
<span class='line'> 43</span> カット（＝ドキュメント）のエントリは空のままでも良いがOPUSを持たないタイトルはアプリの表示規則上許可されない
<span class='line'> 44</span> 
<span class='line'> 45</span> 
<span class='line'> 46</span> 主にローカルリポジトリや、ホームリポジトリでの使用を前提とする?
<span class='line'> 47</span> 
<span class='line'> 48</span> 
<span class='line'> 49</span>     documentDepot.documents
<span class='line'> 50</span>     
<span class='line'> 51</span> ドキュメントエントリーコレクション　サービスにアクセスするごとに更新
<span class='line'> 52</span> ドキュメントエントリはカプセル化されたオブジェクトにする　SCi互換
<span class='line'> 53</span> ListEntry オブジェクトのコレクションとして実装
<span class='line'> 54</span> 
<span class='line'> 55</span>     currentProduct      　　現在ブラウザで選択中のプロダクト識別子
<span class='line'> 56</span>     currentSelection        現在ブラウザで選択中のドキュメント識別子
<span class='line'> 57</span>     currentDocument         現在編集対象のXps      (xUI.XPS の相互参照)
<span class='line'> 58</span>     currentReferenece       現在表示対象の参考Xps  (xUI.referenceXPSの相互参照)
<span class='line'> 59</span> として扱う
<span class='line'> 60</span> */</span><span class="WHIT">
<span class='line'> 61</span> </span><span class="COMM">//エントリを格納するオブジェクト xUIを再初期化するのでこのコードが消える</span><span class="WHIT">
<span class='line'> 62</span> </span><span class="COMM">//良くない</span><span class="WHIT">
<span class='line'> 63</span> </span><span class="COMM">/** @class アプリケーション内でドキュメントエントリを格納するクラス
<span class='line'> 64</span>  */</span><span class="WHIT">
<span class='line'> 65</span> </span><span class="NAME">documentDepot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 66</span> </span><span class="WHIT">    </span><span class="NAME">products</span><span class="WHIT">    </span><span class="PUNC">:</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 67</span> </span><span class="WHIT">    </span><span class="NAME">documents</span><span class="WHIT">   </span><span class="PUNC">:</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 68</span> </span><span class="WHIT">    </span><span class="NAME">currentProduct</span><span class="PUNC">:</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 69</span> </span><span class="WHIT">    </span><span class="NAME">currentSelection</span><span class="PUNC">:</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 70</span> </span><span class="WHIT">    </span><span class="NAME">currentDocument</span><span class="PUNC">:</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 71</span> </span><span class="WHIT">    </span><span class="NAME">currentReferenece</span><span class="PUNC">:</span><span class="KEYW">null</span><span class="WHIT">
<span class='line'> 72</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 73</span> </span><span class="COMM">/**
<span class='line'> 74</span>  *  ドキュメントブラウザの保持データを初期化
<span class='line'> 75</span>  *
<span class='line'> 76</span>  *    ドキュメントセレクタのアップデートを行う&lt;br />
<span class='line'> 77</span>  *    タイトルリスト及びドキュメントコレクションをクリア後&lt;br />
<span class='line'> 78</span>  *    リポジトリのエントリリストを走査してコレクションを再構築してブラウザをアップデートする
<span class='line'> 79</span>  *    ** リポジトリ(エントリリスト)の更新は行わない　必要に従って事前に更新の要あり
<span class='line'> 80</span>  *
<span class='line'> 81</span>  *    逐次的に画面の再描画が可能なように変更する20170322
<span class='line'> 82</span>  *
<span class='line'> 83</span>  *    引数リストを受けて、現在のエントリと比較を行い逐次更新を行うように変更するか?
<span class='line'> 84</span>  *    ならば　事前に引数リスト組む必要あり
<span class='line'> 85</span>  *    または　参照するエントリリストの複製を持って差分のみの更新を行う？　複製が大変？
<span class='line'> 86</span> */</span><span class="WHIT">
<span class='line'> 87</span> </span><span class="NAME">documentDepot.documentsUpdate</span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 88</span> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">'=+=============+++===== documentsUpdate '</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 89</span> </span><span class="COMM">/*  既存データをクリアしない
<span class='line'> 90</span> 引数で受け取ったデータ群は、新規のデータ構造を組んで従来のデータと照合しながら更新を行う
<span class='line'> 91</span>     既存エントリ＞新規データで置き換え
<span class='line'> 92</span>     新規エントリ＞新規データから追加
<span class='line'> 93</span> リムーブの機能が必要となるが、それをどうするか？
<span class='line'> 94</span>     ○エントリそのものにリムーブメソッドを設ける
<span class='line'> 95</span>     ○アップデートメソッドに第二引数を設けてリストを与えて処理する
<span class='line'> 96</span> 
<span class='line'> 97</span> 大量のリストが与えられた場合に、逐次的に一定数で画面をリフレッシュする（リストを分割処理する）機能を作る?
<span class='line'> 98</span> エントリ全体の比較更新と、逐次リフレッシュを機能分割したほうが良さそう？
<span class='line'> 99</span> 
<span class='line'>100</span> ただし全体のパフォーマンスをひどく下げているのは、ServiceAgent.getList の再帰呼び出しなのでこの処理は後回しでもOK　2017.04.19
<span class='line'>101</span> 
<span class='line'>102</span> */</span><span class="WHIT">
<span class='line'>103</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.products</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>104</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.getProducts</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>105</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.documents</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.entryList</span><span class="PUNC">;</span><span class="COMM">//カレントリポジトリのリストのみ</span><span class="WHIT">
<span class='line'>106</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>107</span> </span><span class="COMM">/**
<span class='line'>108</span>  *    カレントのドキュメント情報からプロダクト識別子の配列を抽出して戻す
<span class='line'>109</span>  *    @return {Array}
<span class='line'>110</span> */</span><span class="WHIT">
<span class='line'>111</span> </span><span class="NAME">documentDepot.getProducts</span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>112</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myProducts</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>113</span> </span><span class="COMM">//productsData を走査してプロダクトリストを作成する</span><span class="WHIT">
<span class='line'>114</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.productsData.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>115</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myTitle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.productsData</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>116</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">serviceAgent.currentRepository.productsData</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">episodes</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>117</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ide</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ide</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.productsData</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">episodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ide</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>118</span> </span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myOpus</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.productsData</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">episodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">ide</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>119</span> </span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mySubtitle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.productsData</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">episodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">ide</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">description</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>120</span> </span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myIdentifier</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>121</span> </span><span class="WHIT">                        </span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myTitle</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="WHIT">
<span class='line'>122</span> </span><span class="WHIT">                    </span><span class="STRN">"#"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myOpus</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="WHIT">
<span class='line'>123</span> </span><span class="WHIT">                    </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">mySubtitle</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="STRN">"["</span><span class="PUNC">+</span><span class="NAME">mySubtitle</span><span class="PUNC">+</span><span class="STRN">"]"</span><span class="PUNC">:</span><span class="STRN">""</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>124</span> </span><span class="WHIT">                </span><span class="NAME">myProducts.push</span><span class="PUNC">(</span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>125</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>126</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>127</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>128</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.products</span><span class="PUNC">=</span><span class="NAME">myProducts</span><span class="WHIT">
<span class='line'>129</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myProducts</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>130</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>131</span> 
<span class='line'>132</span> </span><span class="COMM">/*  OPUSセレクタを更新する
<span class='line'>133</span> 引数:エントリフィルタ用正規表現
<span class='line'>134</span> 戻値:フィルタリング済のリスト配列
<span class='line'>135</span> 更新後のセレクタ内に現在の被選択アイテムがある場合はそれを選択状態にする
<span class='line'>136</span> ない場合は選択アイテムを空に
<span class='line'>137</span> プロダクトリストは、都度生成に変更（スタティックには持たない）
<span class='line'>138</span>  */</span><span class="WHIT">
<span class='line'>139</span> </span><span class="NAME">documentDepot.updateOpusSelector</span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">myRegexp</span><span class="PUNC">,</span><span class="NAME">rev</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>140</span> </span><span class="COMM">//    if(! serviceAgent.currentRepository.opusList.updated){return;}</span><span class="WHIT">
<span class='line'>141</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">myRegexp</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">myRegexp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">".+"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>142</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">rev</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>143</span> </span><span class="COMM">// ここで正規表現フィルタを引数にする</span><span class="WHIT">
<span class='line'>144</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>145</span> </span><span class="COMM">//    var myProducts = documentDepot.getProducts();</span><span class="WHIT">
<span class='line'>146</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myProducts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">documentDepot.products</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>147</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myResult</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">    </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myProducts.length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT">
<span class='line'>149</span> </span><span class="WHIT">    </span><span class="STRN">'&lt;option value="==newTitle==" selected>（*-- no title selected --*）&lt;/option>'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>150</span> </span><span class="WHIT">    </span><span class="STRN">'&lt;option value="==newTitle==" selected>（*-- no titles --*）&lt;/option>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">opid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">opid</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myProducts.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">opid</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>152</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myProducts</span><span class="PUNC">[</span><span class="NAME">opid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>153</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">show</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentText.match</span><span class="PUNC">(</span><span class="NAME">myRegexp</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">:</span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>154</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">rev</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">show</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">show</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>155</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">show</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>156</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;option'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>157</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">' value="'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>158</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myProducts</span><span class="PUNC">[</span><span class="NAME">opid</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>159</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">documentDepot.currentProduct</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">myProducts</span><span class="PUNC">[</span><span class="NAME">opid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>160</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'" selected>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>161</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>162</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'">'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>163</span> </span><span class="WHIT">                </span><span class="NAME">documentDepot.currentProduct</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>164</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>165</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentText</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>166</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;/option>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>167</span> </span><span class="WHIT">            </span><span class="NAME">myResult.push</span><span class="PUNC">(</span><span class="NAME">myProducts</span><span class="PUNC">[</span><span class="NAME">opid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>168</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>169</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>170</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"opusSelect"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>171</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"opusSelect"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>172</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"opusSelect"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>173</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>174</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myResult</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>175</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>176</span> </span><span class="COMM">/*  Documentセレクタを更新
<span class='line'>177</span> 引数:エントリフィルタ用正規表現
<span class='line'>178</span> 戻値:フィルタリング済のリスト配列
<span class='line'>179</span> 被選択ドキュメントが更新後のセレクタ内に存在する場合は、それを選択状態にする
<span class='line'>180</span> ない場合は選択アイテムを空にする
<span class='line'>181</span> 
<span class='line'>182</span> 引数は正規表現よりも[開始番号,終了番号（表示個数？）]あたりにしたほうが何かと良いので順次変更
<span class='line'>183</span> ドキュメントエントリは、ステータスを認識するように改修
<span class='line'>184</span> Aborted ステータスのエントリは、制作管理モードでのみ表示
<span class='line'>185</span>  */</span><span class="WHIT">
<span class='line'>186</span> </span><span class="WHIT"> </span><span class="NAME">documentDepot.updateDocumentSelector</span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">myRegexp</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>187</span> </span><span class="COMM">// ここで正規表現フィルタを引数にする？</span><span class="WHIT">
<span class='line'>188</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">myRegexp</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">myRegexp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">".+"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>189</span> </span><span class="COMM">// 選択済みタイトルで抽出</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myDocuments</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">documentDepot.getEntriesByOpusid</span><span class="PUNC">(</span><span class="NAME">documentDepot.currentProduct</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>191</span> </span><span class="COMM">//  正規表現フィルタで抽出してHTMLを組む</span><span class="WHIT">
<span class='line'>192</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>193</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myResult</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>194</span> </span><span class="WHIT">    </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="PUNC">(</span><span class="NAME">myDocuments.length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>195</span> </span><span class="WHIT">    </span><span class="STRN">'&lt;option value="==newDocument==" selected>（*-- no document selected--*）&lt;/option>'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>196</span> </span><span class="WHIT">    </span><span class="STRN">'&lt;option value="==newDocument==" selected>（*-- no documents --*）&lt;/option>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>197</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dlid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">dlid</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myDocuments.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">dlid</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>198</span> </span><span class="COMM">//全ドキュメント走査</span><span class="WHIT">
<span class='line'>199</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myDocuments</span><span class="PUNC">[</span><span class="NAME">dlid</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">toString</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>200</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myDocuments</span><span class="PUNC">[</span><span class="NAME">dlid</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>201</span> </span><span class="COMM">//console.log(currentData.cut)</span><span class="WHIT">
<span class='line'>202</span> </span><span class="WHIT">       </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentStatus</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentData.getStatus</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>203</span> </span><span class="COMM">//console.log(currentData);console.log(currentStatus)</span><span class="WHIT">
<span class='line'>204</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentData.dataInfo.currentStatus.content.indexOf</span><span class="PUNC">(</span><span class="STRN">'Aborted'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>205</span> </span><span class="WHIT">            </span><span class="PUNC">(</span><span class="NAME">currentData.dataInfo.sci</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">cut.match</span><span class="PUNC">(</span><span class="NAME">myRegexp</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>206</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;option'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>207</span> 
<span class='line'>208</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">' class="docStatus docStatus-'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>209</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentStatus</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>210</span> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">currentStatus</span><span class="PUNC">==</span><span class="STRN">'Fixed'</span><span class="PUNC">)</span><span class="PUNC">&&</span><span class="PUNC">(</span><span class="NAME">currentStatus.assign</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>211</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"-2"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>212</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>213</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'"'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>214</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">' value="'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>215</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myDocuments</span><span class="PUNC">[</span><span class="NAME">dlid</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>216</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.currentSelection</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">myDocuments</span><span class="PUNC">[</span><span class="NAME">dlid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'" selected >'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>218</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'">'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>220</span> </span><span class="WHIT">                </span><span class="NAME">this.currentSelection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>221</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>222</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentText</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>223</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">' ['</span><span class="PUNC">+</span><span class="NAME">currentStatus.content</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>224</span> </span><span class="WHIT">            </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">']&lt;/option>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>225</span> </span><span class="WHIT">            </span><span class="NAME">myResult.push</span><span class="PUNC">(</span><span class="NAME">myDocuments</span><span class="PUNC">[</span><span class="NAME">dlid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>227</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>228</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"cutList"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>229</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"cutList"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>230</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"cutList"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>231</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>232</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myResult</span><span class="PUNC">;</span><span class="COMM">//抽出したリスト</span><span class="WHIT">
<span class='line'>233</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>234</span> 
<span class='line'>235</span> </span><span class="COMM">/*
<span class='line'>236</span>   現在の全エントリから　プロダクトIDが一致するエントリを抽出してカット順にソートして返す
<span class='line'>237</span> 引数:プロダクト識別子
<span class='line'>238</span>  */</span><span class="WHIT">
<span class='line'>239</span> </span><span class="NAME">documentDepot.getEntriesByOpusid</span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>240</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="WHIT"> </span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">myIdentifier</span><span class="PUNC">=</span><span class="NAME">documentDepot.currentProduct</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>241</span> </span><span class="WHIT">    </span><span class="NAME">myIdentifier</span><span class="PUNC">+</span><span class="PUNC">=</span><span class="STRN">"//"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>242</span> </span><span class="COMM">// タイトルIDで抽出</span><span class="WHIT">
<span class='line'>243</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myDocuments</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>244</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dcid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">dcid</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">documentDepot.documents.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">dcid</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>245</span> </span><span class="COMM">//console.log(documentDepot.documents[dcid].toString());console.log(myIdentifier);</span><span class="WHIT">
<span class='line'>246</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">documentDepot.currentProduct</span><span class="PUNC">)</span><span class="PUNC">&&</span><span class="PUNC">(</span><span class="NAME">Xps.compareIdentifier</span><span class="PUNC">(</span><span class="NAME">documentDepot.documents</span><span class="PUNC">[</span><span class="NAME">dcid</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>247</span> </span><span class="WHIT">            </span><span class="NAME">myDocuments.push</span><span class="PUNC">(</span><span class="NAME">documentDepot.documents</span><span class="PUNC">[</span><span class="NAME">dcid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>248</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>249</span> </span><span class="WHIT">         </span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>251</span> </span><span class="WHIT">    </span><span class="NAME">myDocuments.sort</span><span class="PUNC">(</span><span class="NAME">documentDepot.sortBySCi</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>252</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myDocuments</span><span class="PUNC">;</span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>253</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>254</span> 
<span class='line'>255</span> </span><span class="COMM">/**
<span class='line'>256</span> listEntryのカット番号順にソートする　評価関数
<span class='line'>257</span> */</span><span class="WHIT">
<span class='line'>258</span> </span><span class="NAME">documentDepot.sortBySCi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">val1</span><span class="PUNC">,</span><span class="NAME">val2</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nas.parseNumber</span><span class="PUNC">(</span><span class="NAME">val1.sci</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="NAME">nas.parseNumber</span><span class="PUNC">(</span><span class="NAME">val2.sci</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>259</span> </span><span class="COMM">/**
<span class='line'>260</span>     読み出して編集エリアに取り込む
<span class='line'>261</span>     識別子が指定されない場合は、セレクタの値を見る
<span class='line'>262</span>     ドキュメントリストに識別子が存在しない場合は、falseを返す
<span class='line'>263</span>     読み込み成功時はセレクタが開いていたら閉じる
<span class='line'>264</span> */</span><span class="WHIT">
<span class='line'>265</span> </span><span class="NAME">documentDepot.getEntry</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>266</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">myIdentifier</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>267</span> </span><span class="WHIT">        </span><span class="NAME">myIdentifier</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">documentDepot.currentSelection</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>268</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>269</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">did</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">did</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">documentDepot.documents.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">did</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>270</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">documentDepot.documents</span><span class="PUNC">[</span><span class="NAME">did</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>271</span> </span><span class="WHIT">            </span><span class="NAME">documentDepot.documents</span><span class="PUNC">[</span><span class="NAME">did</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">parent.getEntry</span><span class="PUNC">(</span><span class="NAME">myIdentifier</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>272</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>273</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>274</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>275</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="WHIT">
<span class='line'>276</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>277</span> </span><span class="COMM">/**
<span class='line'>278</span>     現在のテキスト入力状態から識別子をビルドする。
<span class='line'>279</span> */</span><span class="WHIT">
<span class='line'>280</span> </span><span class="NAME">documentDepot.buildIdentifier</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">addStatus</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>281</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">=</span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>282</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'titleInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value.match</span><span class="PUNC">(</span><span class="REGX">/\(\*.*\*/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>283</span> </span><span class="WHIT">        </span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'titleInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>284</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'opusInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value.match</span><span class="PUNC">(</span><span class="REGX">/\(\*.*\*/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">"#"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>285</span> </span><span class="WHIT">        </span><span class="STRN">'#'</span><span class="PUNC">+</span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'opusInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>286</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'subtitleInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value.match</span><span class="PUNC">(</span><span class="REGX">/\(\*.*\*/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>287</span> </span><span class="WHIT">        </span><span class="STRN">'['</span><span class="PUNC">+</span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'subtitleInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">']'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>288</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'//'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>289</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mySCi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="NAME">Xps.parseSCi</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'cutInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value.match</span><span class="PUNC">(</span><span class="REGX">/\(\*.*\*\)/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>290</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'cutInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">'('</span><span class="PUNC">+</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'timeInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">+</span><span class="STRN">')'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>291</span> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">dbg</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">mySCi</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>292</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myNames</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Xps.parseCutIF</span><span class="PUNC">(</span><span class="NAME">mySCi</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">cut</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>293</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myNames.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">'s'</span><span class="PUNC">+</span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myNames</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">'-c'</span><span class="PUNC">:</span><span class="STRN">'s-c'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>294</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">myNames</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="STRN">""</span><span class="PUNC">:</span><span class="NAME">encodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myNames</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>295</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">timeSpc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">nas.FCT2Frm</span><span class="PUNC">(</span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">mySCi</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">time</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">timeSpc</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>297</span> </span><span class="WHIT">    </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'( '</span><span class="PUNC">+</span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">timeSpc</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">' )'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>298</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>299</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">addStatus</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>300</span> </span><span class="WHIT">        </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="STRN">'//'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>301</span> </span><span class="WHIT">        </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'issueSelector'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>302</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>303</span> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">dbg</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">"buildIdentifier::"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>304</span> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">dbg</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">mySCi</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">time</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>305</span> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">dbg</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>306</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>307</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>308</span> </span><span class="COMM">/**
<span class='line'>309</span>     ドキュメントリストを更新する
<span class='line'>310</span>     カレントリポジトリの内容を取得
<span class='line'>311</span>     得たリストをブラウザの保持リストとして更新する
<span class='line'>312</span>     先に存在するリストは破棄
<span class='line'>313</span>     この処理をカットのステータス変更の度に行うとレスポンスの低下が著しいので
<span class='line'>314</span>     要変更
<span class='line'>315</span>     当該のカットの状況のみをアップデートする手続が必要
<span class='line'>316</span>     実際は
<span class='line'>317</span>     LocalRepositoryの場合listEntryのアップデートのみでOK
<span class='line'>318</span>     NetworkRepositoryの場合はサーバのレスポンスからlistEntryをアップデートする
<span class='line'>319</span> */</span><span class="WHIT">
<span class='line'>320</span> </span><span class="NAME">documentDepot.rebuildList</span><span class="PUNC">=</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">force</span><span class="PUNC">,</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>321</span> </span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>322</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.currentProduct</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>323</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.currentSelection</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>324</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.products</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>325</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.getProducts</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>326</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.documents</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.entryList</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>327</span> </span><span class="COMM">//    documentDepot.currentDocument    =null;</span><span class="WHIT">
<span class='line'>328</span> </span><span class="COMM">//    documentDepot.currentReferenece  =null;</span><span class="WHIT">
<span class='line'>329</span> </span><span class="COMM">/*=============*/</span><span class="WHIT">
<span class='line'>330</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">force</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">force</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>331</span> </span><span class="COMM">//    serviceAgent.currentRepository.getProducts(force,callback);</span><span class="WHIT">
<span class='line'>332</span> </span><span class="COMM">//    serviceAgent.currentRepository.getList(force,callback);</span><span class="WHIT">
<span class='line'>333</span> </span><span class="COMM">//  テスト中はこれで良いが、その後はあまり良くない</span><span class="WHIT">
<span class='line'>334</span> </span><span class="COMM">//console.log(this);</span><span class="WHIT">
<span class='line'>335</span> </span><span class="COMM">//console.log(callback);</span><span class="WHIT">
<span class='line'>336</span> </span><span class="COMM">//    documentDepot.documentsUpdate();</span><span class="WHIT">
<span class='line'>337</span> </span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>338</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>339</span> </span><span class="COMM">/**
<span class='line'>340</span> 読み出し・請求
<span class='line'>341</span>     明示的にリスト内のサーバにアクセスする場合は、その時点の最新リストを請求してリストを更新する
<span class='line'>342</span>     キャッシュを利用する場合は、リストの更新はなし。
<span class='line'>343</span>     
<span class='line'>344</span> 書き込み・更新
<span class='line'>345</span>     データの保存は、
<span class='line'>346</span>         アプリケーション終了（ウインドウクローズ）時の自動バックアップ
<span class='line'>347</span>         明示的なバックアップへの退避（↑上と同じ領域）
<span class='line'>348</span> 
<span class='line'>349</span>         保存先「リポジトリ」を指定して保存
<span class='line'>350</span>         上書き保存
<span class='line'>351</span>             「リポジトリ」の指定がない場合は、上書き保存
<span class='line'>352</span>         新規作成時
<span class='line'>353</span>             カレントリポジトリを使用
<span class='line'>354</span>             任意のリポジトリを指定するには保存前にカレントの変更が必要
<span class='line'>355</span>             
<span class='line'>356</span> リポジトリについて
<span class='line'>357</span>     リポジトリは、このシステム上「データ保存場所」に識別用の名前を付けて管理対象としたもの。
<span class='line'>358</span> 
<span class='line'>359</span>     タイムシート・カット袋等の制作管理及びカット内容のメタデータ　及び将来的には、これらのデータに記載された制作データそのものを保存
<span class='line'>360</span>     ユーザのリクエストに従って読み書き可能なサービスとする。
<span class='line'>361</span> 
<span class='line'>362</span>     リポジトリには、基本的に制作管理DBの機能はない。
<span class='line'>363</span>     制作管理DBの機能は、一般のRDBMサービスを立ち上げそこで利用するものとする。
<span class='line'>364</span>     基本的にリポジトリとは別の接続を使用する
<span class='line'>365</span>     
<span class='line'>366</span>     簡易的なデータの解釈は、リポジトリから読み出したデータをアプリケーションがパースして行う。
<span class='line'>367</span>     簡易のパース結果を識別子としてリポジトリに送り、それをファイル名又はそれに類するメタ情報として保存して利用する
<span class='line'>368</span>     リポジトリにはデータの解釈（解析）を求めない。
<span class='line'>369</span>     
<span class='line'>370</span>         １＞必要なデータを保存時に識別子としてデータにつけてアプリケーション側から送信する
<span class='line'>371</span>         ２＞リポジトリサーバは、その識別子を利用して保存を行う
<span class='line'>372</span>                 リスト要素を分解するか否かはサーバ側の事情で使い分けて良い
<span class='line'>373</span>                 階層管理する場合は、要素ごとに分解してディレクトリを分ける等の処理を行うとデータの管理が容易になる
<span class='line'>374</span>                  /(作品)/(話数)/(カット)/(ライン)/(ステージ)/(ジョブ)/(タイムシートデータ) 等のデータ配置にすると
<span class='line'>375</span>                  バックアップやレストア等の処理に利便性あり
<span class='line'>376</span>         
<span class='line'>377</span>     識別子の型式（埋め込み情報）は以下の様にする（仮仕様　2016/11/20）
<span class='line'>378</span>     
<span class='line'>379</span> title＃opus[subtitle]//SsceneCcut(seconds+frames) / SsceneCcut(seconds+frames) / SsceneCcut(seconds+frames) //lineID//stageID//jobID//
<span class='line'>380</span> 
<span class='line'>381</span> 例:
<span class='line'>382</span>     origData
<span class='line'>383</span> かちかち山Max#おためし[サンプルカット] // S-C10(72) //0//0//0
<span class='line'>384</span>     encodeURIComponent
<span class='line'>385</span> %E3%81%8B%E3%81%A1%E3%81%8B%E3%81%A1%E5%B1%B1Max#%E3%81%8A%E3%81%9F%E3%82%81%E3%81%97[%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%AB%E3%83%83%E3%83%88] // S-C10(72) //0//0//0
<span class='line'>386</span> 
<span class='line'>387</span> 
<span class='line'>388</span> タイトル・カット番号・サブタイトル等のデータにはセパレータ等の予約文字列が含まれるケースがあるので識別子を作成前にURI置換を行う必要あり
<span class='line'>389</span> 置き換え又はエスケープの必要な文字列（使用禁止のセンも考慮）
<span class='line'>390</span> \n  　　改行　           - 使用禁止
<span class='line'>391</span> /   　　スラッシュ       - \###
<span class='line'>392</span> #＃No.　ナンバーサイン   - 
<span class='line'>393</span> [ ] 　　角括弧           - 
<span class='line'>394</span> 「 」 　カギ括弧         - 
<span class='line'>395</span> "'  　　引用符           - 
<span class='line'>396</span> encodeURIComponent() を識別子組み立て前に通す
<span class='line'>397</span> 必要に従ってdecodeURIComponent()
<span class='line'>398</span> 
<span class='line'>399</span> 　  上記の型式で（今回実装のローカルリポジトリではこの方法を採用する）        
<span class='line'>400</span>     簡易パース手順
<span class='line'>401</span>         split("//")
<span class='line'>402</span>             5要素なら上書き可
<span class='line'>403</span>             6要素ならロック(fix)されて上書き不可
<span class='line'>404</span>             
<span class='line'>405</span>             第一要素　プロダクト識別子　パース手順あり
<span class='line'>406</span>             第二要素　SCi識別子
<span class='line'>407</span>                 split("/")
<span class='line'>408</span>                 第一要素代表カット番号　第二要素以降は兼用番号　第一要素と同じ番号が入る場合があるがその場合は無視
<span class='line'>409</span>                 各要素はカット番号とカット尺に分解して利用　カット尺は省略可能
<span class='line'>410</span>             第三要素    ラインID   (Int 通番)　 各要素にname要素を付加しても良い　0:本線//1:レイアウト//0:打合せ　等
<span class='line'>411</span>             第四要素    ステージID (Int 通番)
<span class='line'>412</span>             第五要素    ジョブID   (Int 通番)
<span class='line'>413</span>             第六要素    ジョブステータス　値は文字列 Startup/Active/Hold/Fixed/Aborted いずれか
<span class='line'>414</span> 
<span class='line'>415</span> *   作業ステージを閉じる処理は、ユーザがアプリケーション側で行う
<span class='line'>416</span>     その際、識別子にフィックスのサインを付加する（第六要素'Fixed'）
<span class='line'>417</span>     フィックスされたデータが上書きされることはない　データの請求は常に有効
<span class='line'>418</span>     将来的には、ステージ/ジョブを内部に備えたXps,xMap 等が利用されるが、その際もこの識別子はそのまま使用可能
<span class='line'>419</span> 
<span class='line'>420</span> りまぴんで呼び出しの際は、基本的に既fixのデータはリファレンスに　未fixのデータは編集エリアに読み込む
<span class='line'>421</span>     
<span class='line'>422</span>     第一要素をパースしてタイトル/OPUS情報を取得可能
<span class='line'>423</span>     第二要素を split("/")　で兼用情報が得られる　第一要素が当該のカット番号
<span class='line'>424</span>         各カット情報は カット番号(カット尺) *durationではない　transition情報もない（この通信では不用）
<span class='line'>425</span>         プロトコル上は(カッコ内)は補助情報とする
<span class='line'>426</span>             duration,transition等の情報を追加することも可能？
<span class='line'>427</span>         
<span class='line'>428</span> 以上の機能をアプリケーション側で処理することで、RDBMのない状態で通常のストレージをリポジトリとして使用可能になる
<span class='line'>429</span> とくにローカルファイルシステムを使う際は
<span class='line'>430</span>     URIエンコードを施しファイル名規則に抵触するのを避ける
<span class='line'>431</span>     長いファイル名を利用できる環境を使用すること
<span class='line'>432</span>     識別子は分解してディレクトリをわけて保存するか、又はエスケープしてスラッシュがファイル名に含まれるの避ける
<span class='line'>433</span> 
<span class='line'>434</span>     リポジトリに要求される機能は、
<span class='line'>435</span>         1.アプリケーションからの請求に従って、保存しているデータの識別子リストを送り返す
<span class='line'>436</span>         2.アプリケーションから送信された(識別子付き)データを受信して、
<span class='line'>437</span>             同じ識別子のエントリがあれば上書きする
<span class='line'>438</span>             エントリがない場合は新規に保存エントリを作成する
<span class='line'>439</span>         3.アプリケーションからの請求に従って、指定された識別子の保存データを送信する
<span class='line'>440</span>         
<span class='line'>441</span>     1.      list(filter)
<span class='line'>442</span>         あまりエントリ数が多いと待ち時間が増すので、フィルタ機能はあったほうが良い
<span class='line'>443</span>         （アプリケーション側でもフィルタするので無くても良い）
<span class='line'>444</span>     2.      write(identifier)
<span class='line'>445</span>         識別子のエントリがない場合は、新規エントリを登録
<span class='line'>446</span>     3.      read(identifier)
<span class='line'>447</span>         識別子のエントリがない場合は。操作失敗のレスポンスを返す
<span class='line'>448</span> 
<span class='line'>449</span> * webStorage には一般的なリスト機能はないが　全キーを取得してリストを構築することは可能
<span class='line'>450</span>     リストオブジェクトをJSONパースしてストレージに一括で納める？
<span class='line'>451</span> ただし、ブラウザ全体で５MB程度ととして、シートエディタのみでこれを専有するわけにもいかないので基本的にはドキュメントエントリ数を限って扱う。
<span class='line'>452</span> 試験的には複数エントリが扱えるように組む（ローカルファイルやDropBox/GoogleDrive等のネットストレージに対応するため）
<span class='line'>453</span> 
<span class='line'>454</span> 
<span class='line'>455</span> */</span><span class="WHIT">
<span class='line'>456</span> </span><span class="COMM">/**
<span class='line'>457</span>     入力されたタイトルを評価してセレクタを切り替える
<span class='line'>458</span> */</span><span class="WHIT">
<span class='line'>459</span> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">selectBrowser</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>460</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myTitle</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'titleInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>461</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myOpus</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'opusInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>462</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mySubtitle</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'subtitleInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>463</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myCutNo</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'cutInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>464</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myTime</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'timeInput'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>465</span> </span><span class="COMM">/*
<span class='line'>466</span>     セレクタの中から該当するエントリを検索して　存在すればそのエントリを選択状態にする
<span class='line'>467</span>     手続きは、セレクタ側の各要素を分解して下位から順に評価
<span class='line'>468</span>     明確に異なる値があった時点でエントリをリジェクト
<span class='line'>469</span>     すべてリジェクトされた場合フリーエントリを選択状態にする
<span class='line'>470</span>     サブタイトル・カット秒数は特に評価しない
<span class='line'>471</span> */</span><span class="WHIT">
<span class='line'>472</span> 
<span class='line'>473</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>474</span> </span><span class="COMM">/**
<span class='line'>475</span>     タイトルを選択して入力エリア/カットセレクタを更新
<span class='line'>476</span>     productNameは以下の型式で分解する
<span class='line'>477</span>     (タイトル)[#＃№](番号)[(サブタイトル)]
<span class='line'>478</span>     
<span class='line'>479</span>     ももたろう＃12 [キジ参戦！ももたろう地獄模様！！]
<span class='line'>480</span>     源氏物語 #23帖 [初音]
<span class='line'>481</span>     
<span class='line'>482</span>     タイトルと話数はナンバーサイン[#＃№]で区切る
<span class='line'>483</span>     サブタイトルが存在する場合は、[]角括弧,「」カギ括弧,""引用符で区切って記入する
<span class='line'>484</span> */</span><span class="WHIT">
<span class='line'>485</span> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">setProduct</span><span class="PUNC">(</span><span class="NAME">productName</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>486</span> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">'setProduct####'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>487</span> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">productName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>488</span> 
<span class='line'>489</span> </span><span class="COMM">//ドキュメント（カット）ブラウザの表示をリセット（クリア）</span><span class="WHIT">
<span class='line'>490</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'cutList'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"&lt;option selected>（*-- no document --*）"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>491</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.updateDocumentSelector</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>492</span> </span><span class="COMM">//    selectSCi();</span><span class="WHIT">
<span class='line'>493</span> </span><span class="COMM">//ブラウザの選択を解除</span><span class="WHIT">
<span class='line'>494</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.currentSelection</span><span class="PUNC">=</span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>495</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"cutList"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="PUNC">=</span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>496</span> </span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>497</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">productName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>498</span> </span><span class="WHIT">    </span><span class="COMM">//プロダクト名が引数で与えられない場合はセレクタの値をとる</span><span class="WHIT">
<span class='line'>499</span> </span><span class="WHIT">    </span><span class="COMM">//選択されたアイテムがない場合は、デフォルト値を使用してフリー要素を選択する</span><span class="WHIT">
<span class='line'>500</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>501</span> </span><span class="WHIT">            </span><span class="NAME">productName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT">
<span class='line'>502</span> </span><span class="WHIT">            </span><span class="STRN">"#[]"</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">options</span><span class="PUNC">[</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>504</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>505</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>506</span> </span><span class="WHIT">            </span><span class="NAME">productName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"#[]"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>507</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>508</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>509</span> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">"changeSelector"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>510</span> </span><span class="WHIT">    </span><span class="COMM">//プロダクト名が与えられた場合は、セレクタの選択を更新する</span><span class="WHIT">
<span class='line'>511</span> </span><span class="WHIT">          </span><span class="COMM">//  document.getElementById('opusSelect').value=productName;</span><span class="WHIT">
<span class='line'>512</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pix</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">pix</span><span class="PUNC">&lt;</span><span class="NAME">documentDepot.products.length</span><span class="PUNC">;</span><span class="NAME">pix</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>513</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">Xps.compareIdentifier</span><span class="PUNC">(</span><span class="NAME">documentDepot.products</span><span class="PUNC">[</span><span class="NAME">pix</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">productName</span><span class="PUNC">)</span><span class="PUNC">>=</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>514</span> </span><span class="WHIT">                </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'opusSelect'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">=</span><span class="NAME">documentDepot.products</span><span class="PUNC">[</span><span class="NAME">pix</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>515</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>516</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>517</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>518</span> </span><span class="WHIT">    </span><span class="NAME">productName</span><span class="PUNC">=</span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">productName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//明示的にストリング変換する</span><span class="WHIT">
<span class='line'>519</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">productInfo</span><span class="PUNC">=</span><span class="NAME">Xps.parseProduct</span><span class="PUNC">(</span><span class="NAME">productName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>520</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">subTitle</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">productInfo.subtitle</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>521</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">opus</span><span class="WHIT">        </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">productInfo.opus</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>522</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">title</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">productInfo.title</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>523</span> </span><span class="COMM">/** パネルテキスト更新
<span class='line'>524</span> リストに存在しないプロダクトの場合は、リスト側で'(* new product *)'を選択する
<span class='line'>525</span> */</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>526</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"titleInput"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">title.length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">title</span><span class="PUNC">:</span><span class="STRN">"(*--title--*)"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>527</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusInput"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opus.length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">opus</span><span class="PUNC">:</span><span class="STRN">"(*--opus--*)"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>528</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"subtitleInput"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">subTitle.length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">subTitle</span><span class="PUNC">:</span><span class="STRN">"(*--subtitle--*)"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>529</span> </span><span class="COMM">//    selectSCi();    </span><span class="WHIT">
<span class='line'>530</span> 
<span class='line'>531</span> </span><span class="COMM">// タイトルからカットのリストを構築して右ペインのリストを更新</span><span class="WHIT">
<span class='line'>532</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.currentProduct</span><span class="PUNC">=</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">options</span><span class="PUNC">[</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"opusSelect"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>533</span> 
<span class='line'>534</span> </span><span class="WHIT">    </span><span class="NAME">serviceAgent.currentRepository.getEpisodes</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>535</span> </span><span class="COMM">//        documentDepot.documentsUpdate();</span><span class="WHIT">
<span class='line'>536</span> </span><span class="COMM">//        documentDepot.updateOpusSelector();</span><span class="WHIT">
<span class='line'>537</span> </span><span class="COMM">// 選択したプロダクトが存在すればカットを取得</span><span class="WHIT">
<span class='line'>538</span> </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">documentDepot.currentProduct</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>539</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentOpus</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.opus</span><span class="PUNC">(</span><span class="NAME">documentDepot.currentProduct</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>540</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">currentOpus</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>541</span> </span><span class="COMM">// console.log(currentOpus.token);</span><span class="WHIT">
<span class='line'>542</span> </span><span class="WHIT">            </span><span class="NAME">serviceAgent.currentRepository.getSCi</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>543</span> </span><span class="COMM">// 更新したリストからリスト表示を更新</span><span class="WHIT">
<span class='line'>544</span> </span><span class="WHIT">            </span><span class="NAME">documentDepot.documentsUpdate</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>545</span> </span><span class="WHIT">            </span><span class="NAME">documentDepot.updateDocumentSelector</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="KEYW">false</span><span class="PUNC">,</span><span class="NAME">currentOpus.token</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>548</span> </span><span class="WHIT">           </span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="STRN">"no opus exists ###"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">currentOpus</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>549</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>550</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>551</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.buildIdentifier</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>552</span> </span><span class="WHIT">    </span><span class="NAME">documentDepot.buildIdentifier</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>553</span> </span><span class="WHIT">    </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>554</span> </span><span class="COMM">/*
<span class='line'>555</span> // 選択したプロダクトが存在すればカットを取得
<span class='line'>556</span>     var currentOpus = serviceAgent.currentRepository.opus(documentDepot.currentProduct);
<span class='line'>557</span> if(currentOpus){
<span class='line'>558</span> // console.log(currentOpus.token);
<span class='line'>559</span>     serviceAgent.currentRepository.getSCi(function(){
<span class='line'>560</span> // 更新したリストからリスト表示を更新
<span class='line'>561</span>         documentDepot.documentsUpdate();
<span class='line'>562</span>         documentDepot.updateDocumentSelector();
<span class='line'>563</span>     },false,currentOpus.token);
<span class='line'>564</span>   
<span class='line'>565</span> }else{
<span class='line'>566</span> //該当するプロダクトをコンソールへ
<span class='line'>567</span> console.log(documentDepot.currentProduct);
<span class='line'>568</span> }  */</span><span class="WHIT">
<span class='line'>569</span> </span><span class="COMM">//{        documentDepot.updateDocumentSelector();    }</span><span class="WHIT">
<span class='line'>570</span> </span><span class="COMM">/** パネルテキスト更新
<span class='line'>571</span> リストに存在しないプロダクトの場合は、リスト側で'(* new product *)'を選択する
<span class='line'>572</span> */</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>573</span> </span><span class="COMM">//    document.getElementById("titleInput").value    = (title.length)? title:"(*--title--*)";</span><span class="WHIT">
<span class='line'>574</span> </span><span class="COMM">//    document.getElementById("opusInput").value     = (opus.length)? opus:"(*--opus--*)";</span><span class="WHIT">
<span class='line'>575</span> </span><span class="COMM">//    document.getElementById("subtitleInput").value = (subTitle.length)? subTitle:"(*--subtitle--*)";</span><span class="WHIT">
<span class='line'>576</span> </span><span class="WHIT">    </span><span class="NAME">selectSCi</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>577</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>578</span> </span><span class="COMM">//setProduct("源氏物語＃二十三帖「初音」");</span><span class="WHIT">
<span class='line'>579</span> </span><span class="COMM">/**
<span class='line'>580</span> selectSCi
<span class='line'>581</span> */</span><span class="WHIT">
<span class='line'>582</span> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">selectSCi</span><span class="PUNC">(</span><span class="NAME">sciName</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>583</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">sciName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>584</span> </span><span class="WHIT">    </span><span class="COMM">//カット名が引数で与えられない場合はセレクタの値をとる</span><span class="WHIT">
<span class='line'>585</span> </span><span class="WHIT">    </span><span class="COMM">//セレクタ値の場合は、ドキュメントリストの対応するエントリを取得</span><span class="WHIT">
<span class='line'>586</span> </span><span class="WHIT">    </span><span class="COMM">//選択されたアイテムがない場合は、デフォルト値を使用してフリー要素を選択する</span><span class="WHIT">
<span class='line'>587</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>588</span> </span><span class="WHIT">            </span><span class="COMM">/*  セレクタで選択したカットのissuesをドロップダウンリストで閲覧可能にする
<span class='line'>589</span>                 デフォルト値は最終issue
<span class='line'>590</span>              */</span><span class="WHIT">
<span class='line'>591</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myEntry</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serviceAgent.currentRepository.entry</span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">options</span><span class="PUNC">[</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>592</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">myEntry</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>593</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myContents</span><span class="PUNC">=</span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>594</span> </span><span class="WHIT">            </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ix</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">ix</span><span class="PUNC">&lt;</span><span class="NAME">myEntry.issues.length</span><span class="PUNC">;</span><span class="NAME">ix</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>595</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;option value="'</span><span class="PUNC">+</span><span class="NAME">myEntry.issues</span><span class="PUNC">[</span><span class="NAME">ix</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">'"'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>596</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ix</span><span class="PUNC">==</span><span class="PUNC">(</span><span class="NAME">myEntry.issues.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">' selected >'</span><span class="PUNC">:</span><span class="STRN">' >'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>597</span> </span><span class="WHIT">                </span><span class="NAME">myContents</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">myEntry.issues</span><span class="PUNC">[</span><span class="NAME">ix</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">"&lt;/option>"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>598</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>599</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"issueSelector"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="PUNC">=</span><span class="NAME">myContents</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>600</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">xUI.uiMode</span><span class="PUNC">!=</span><span class="STRN">'management'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"issueSelector"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="PUNC">=</span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>601</span> 
<span class='line'>602</span> </span><span class="WHIT">            </span><span class="NAME">sciName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">options</span><span class="PUNC">[</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>603</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="NAME">console.log</span><span class="PUNC">(</span><span class="NAME">myEntry</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>604</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>605</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"issueSelector"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="PUNC">=</span><span class="STRN">'&lt;option value="" selected>#:---line//#:---stage//#:---job//(status)&lt;/option>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>606</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"issueSelector"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="PUNC">=</span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>607</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>608</span> </span><span class="WHIT">            </span><span class="NAME">sciName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"(*--c#--*)"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>609</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myEntry</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>610</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>611</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>612</span> </span><span class="WHIT">    </span><span class="NAME">sciName</span><span class="PUNC">=</span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">sciName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//明示的にストリング変換する</span><span class="WHIT">
<span class='line'>613</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">sciName.length</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>614</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sciArray</span><span class="PUNC">=</span><span class="NAME">sciName.split</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"/"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//セパレータ"/"で兼用カットを分離</span><span class="WHIT">
<span class='line'>615</span> </span><span class="WHIT">    </span><span class="COMM">//代表カット番号 はsciArray[0]</span><span class="WHIT">
<span class='line'>616</span> </span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>617</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">sciArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">match</span><span class="PUNC">(</span><span class="REGX">/^\s*(.+)\s*\(([^\)]+)\)\s*$/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>618</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cutNumber</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">RegExp.$1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cutTime</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">nas.FCT2Frm</span><span class="PUNC">(</span><span class="NAME">RegExp.$2</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>620</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>621</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cutNumber</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sciArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>622</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cutTime</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT">  </span><span class="NUMB">6</span><span class="PUNC">*</span><span class="NAME">nas.FRATE</span><span class="PUNC">;</span><span class="COMM">//６秒分フレーム</span><span class="WHIT">
<span class='line'>623</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>624</span> 
<span class='line'>625</span> </span><span class="COMM">//  状態更新</span><span class="WHIT">
<span class='line'>626</span> </span><span class="COMM">//　パネルテキスト更新</span><span class="WHIT">
<span class='line'>627</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutInput"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cutNumber.length</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">cutNumber</span><span class="PUNC">:</span><span class="STRN">"(*--c#--*)"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>628</span> </span><span class="WHIT">    </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"timeInput"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cutTime</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nas.Frm2FCT</span><span class="PUNC">(</span><span class="NAME">nas.FCT2Frm</span><span class="PUNC">(</span><span class="NAME">cutTime</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">:</span><span class="STRN">"6 + 00 ."</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>629</span> </span><span class="COMM">//UIボタンの更新</span><span class="WHIT">
<span class='line'>630</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myInputText</span><span class="PUNC">=</span><span class="PUNC">[</span><span class="STRN">"titleInput"</span><span class="PUNC">,</span><span class="STRN">"opusInput"</span><span class="PUNC">,</span><span class="STRN">"subtitleInput"</span><span class="PUNC">,</span><span class="STRN">"cutInput"</span><span class="PUNC">,</span><span class="STRN">"timeInput"</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>631</span> 
<span class='line'>632</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>633</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="WHIT"> </span><span class="NAME">myEntry</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>634</span> </span><span class="COMM">//選択されたドキュメントがリスト内に無い　</span><span class="WHIT">
<span class='line'>635</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"ddp-readout"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>636</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"ddp-reference"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>637</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">xUI.uiMode</span><span class="PUNC">==</span><span class="STRN">'management'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>638</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tidx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">tidx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myInputText.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">tidx</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>639</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="NAME">myInputText</span><span class="PUNC">[</span><span class="NAME">tidx</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>640</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>641</span> </span><span class="WHIT">        </span><span class="NAME">documentDepot.currentSelection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">documentDepot.buildIdentifier</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//現在のテキスト入力状態から識別子をビルドする。</span><span class="WHIT">
<span class='line'>642</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>643</span> </span><span class="COMM">//リポジトリ内に指定データが存在する</span><span class="WHIT">
<span class='line'>644</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentStatus</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myEntry.issues</span><span class="PUNC">[</span><span class="NAME">myEntry.issues.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>645</span> </span><span class="WHIT">    </span><span class="WHIT">
<span class='line'>646</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"ddp-readout"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">xUI.onSite</span><span class="PUNC">)</span><span class="PUNC">&&</span><span class="PUNC">(</span><span class="NAME">serviceAgent.currentStatus</span><span class="PUNC">==</span><span class="STRN">'online-single'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">:</span><span class="KEYW">false</span><span class="PUNC">;</span><span class="COMM">//シングルドキュメント拘束時読出抑制</span><span class="WHIT">
<span class='line'>647</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"ddp-reference"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="COMM">//参照は無条件読出可能</span><span class="WHIT">
<span class='line'>648</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tidx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">tidx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myInputText.length</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">tidx</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>649</span> </span><span class="WHIT">            </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="NAME">myInputText</span><span class="PUNC">[</span><span class="NAME">tidx</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>650</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>651</span> </span><span class="WHIT">        </span><span class="NAME">documentDepot.currentSelection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">options</span><span class="PUNC">[</span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">"cutList"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectedIndex</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>652</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>653</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">xUI.uiMode</span><span class="PUNC">==</span><span class="STRN">'management'</span><span class="PUNC">)</span><span class="PUNC">&&</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">myEntry</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>654</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'ddp-addentry'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>655</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>656</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'ddp-addentry'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>657</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>658</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">myEntry</span><span class="PUNC">)</span><span class="PUNC">&&</span><span class="PUNC">(</span><span class="NAME">serviceAgent.currentRepository</span><span class="PUNC">===</span><span class="NAME">localRepository</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>659</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'ddp-removeentry'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>660</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>661</span> </span><span class="WHIT">        </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="STRN">'ddp-removeentry'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">disabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>662</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>663</span> 
<span class='line'>664</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>665</span> 
<span class='line'>666</span> 
<span class='line'>667</span> </span><span class="COMM">/**
<span class='line'>668</span> プロダクト名　カット番号ともに編集可能とそうでないケースをグラフィックで表示する機能が必要
<span class='line'>669</span> 選択のみで編集不能な場合、文字をグレーアウトさせるか？
<span class='line'>670</span> 最初からグレーアウトで編集キーを押したときのみ編集可能（＝新規作成）とするか　要調整
<span class='line'>671</span> */</span></pre></body></html>