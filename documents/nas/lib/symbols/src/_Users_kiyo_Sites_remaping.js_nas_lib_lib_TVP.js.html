<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="TOKN">﻿</span><span class="COMM">/** * @fileoverview TVP2XPS(TVPStream) * TVPの書き出すcsvファイルをXPS互換テキストにコンバートする * 引き数は、TVP-csvデータのテキストストリーム, * * TVPaint Animation が書き出す素材ファイルのファイル名 * ver1.0 * exportName.layers/Layer ###/###_layerName_#####.png * ver1.1 * exportName.layers/[###] layrtName/[###][#####]layerName|instanceName.png */</span><span class="WHIT"></span><span class="COMM">/** * 全角数字を半角にして数字以外の文字を捨てる * 書き戻し用関数　nasライブラリの汎用サポート部に入れたほうが良いかも * * @param myStr * @returns {XML|string} */</span><span class="WHIT"></span><span class="NAME">nas.clipNum</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myStr</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myStr.replace</span><span class="PUNC">(</span><span class="REGX">/[０１２３４５６７８９]/g</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">h</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">n</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"０１２３４５６７８９"</span><span class="PUNC">.</span><span class="NAME">indexOf</span><span class="PUNC">(</span><span class="NAME">h</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">n</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">"0123456789"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">charAt</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">h</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[^0-9]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">/** * clipNum("!2２３４．．００．９ｑｌｌ"); * 置き換えパターンは場合によっては下記も * ０１２３４５６７８９．，＃－＿｜ * 0123456789.,#-_| */</span><span class="WHIT"></span><span class="COMM">/** * 前後の空白を払う * @param myString * @returns {XML|string} */</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">chopString</span><span class="PUNC">(</span><span class="NAME">myString</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myString.replace</span><span class="PUNC">(</span><span class="REGX">/^\s+/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\s+$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * @param TVPStream * @returns {boolean} * @constructor */</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">TVP2XPS</span><span class="PUNC">(</span><span class="NAME">TVPStream</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * データ冒頭のみチェックして明確に違うストリームの場合はエラーを返す     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">TVPStream.match</span><span class="PUNC">(</span><span class="REGX">/^UTF\-8\,\ TVPaint\,\ \"CSV 1\.\d\"/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * CSVデータをオブジェクト化する     * @type {Object}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * TVP11(CSV 1.0/1.1)のプロパティリスト     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.encoding</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"UTF-8"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.appName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"TVPaint"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.csvVersion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"CSV 1.1"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.ProjectName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.Width</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.Height</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.FrameCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.LayerCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.FrameRate</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.PixelAspectRatio</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.FieldMode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"Progressive"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * レイヤプロパティトレーラ     * @type {{}}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.layerProps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * プロパティ:     * Layers    レイヤ名　＞トラックラベルに変換     * Folder    フルパス　要素配置フォルダ　＞MAP情報　MAP作成時にはグループ作成と同時にMAP書き出し     * Density    Float 0-1 不透明度     * Blending String BlendingMode     * Visible    bool /表示     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">//	myTVP.xSheetMatrix=new Array();//タイムシート配列トレーラ</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * ラインで分割して配列に取り込み     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">TVPStream.match</span><span class="PUNC">(</span><span class="REGX">/\r/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">TVPStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">TVPStream.replace</span><span class="PUNC">(</span><span class="REGX">/\r\n?/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">"\n"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">TVPStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">TVPStream.replace</span><span class="PUNC">(</span><span class="REGX">/\"/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//全ての\"を払う？</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">TVPStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">TVPStream.replace</span><span class="PUNC">(</span><span class="REGX">/\n+/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">"\n"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//繰り返しの空行があれば一つに</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">TVPStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">TVPStream.replace</span><span class="PUNC">(</span><span class="REGX">/\n$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//末尾が改行ならそれも捨てる</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * TVP-csvは、     * 第１・２・３レコードがドキュメントプロパティ・リストと値リストのセット     * 以降は第一フィールドが　#\d+　ならばフレームデータ　それ以外はレイヤプロパティなので     * それらを順次パースする     * 04-20 2016     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">CSVRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">TVPStream.split</span><span class="PUNC">(</span><span class="STRN">"\n"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//改行で分割</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * ドキュメントのバージョン確認     * @type {Array}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">docProps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">CSVRecords</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">","</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.encoding</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chopString</span><span class="PUNC">(</span><span class="NAME">docProps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.appName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chopString</span><span class="PUNC">(</span><span class="NAME">docProps</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.csvVersion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chopString</span><span class="PUNC">(</span><span class="NAME">docProps</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.frameOrigin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="COMM">//フレームオリジネーション判定</span><span class="WHIT"></span><span class="COMM">//	ドキュメントプロパティ取得</span><span class="WHIT"></span><span class="COMM">//	myTVP.SrcData=new Object;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">props</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">CSVRecords</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">","</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">propValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">CSVRecords</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">","</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">pid</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">props.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">pid</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">/**         * プロパティ名から空白を払う         * @type {XML|string}         */</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP</span><span class="PUNC">[</span><span class="PUNC">(</span><span class="NAME">props</span><span class="PUNC">[</span><span class="NAME">pid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\s/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chopString</span><span class="PUNC">(</span><span class="NAME">propValues</span><span class="PUNC">[</span><span class="NAME">pid</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * あらかじめレイヤ数分の配列を作成     * @type {Array}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.layers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="NAME">myTVP.LayerCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myTVP.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Layers</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Folder</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Density</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Blending</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Visible</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * 第4レコードからレイヤデータを取得     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lid</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">CSVRecords.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lid</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentDatas</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">CSVRecords</span><span class="PUNC">[</span><span class="NAME">lid</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">","</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentDatas</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">match</span><span class="PUNC">(</span><span class="REGX">/^#([0-9]+)/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">/**             * レコード冒頭が"#[\d]+"             * @type {Number}             */</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">RegExp.$1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">currentDatas.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentFrame</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chopString</span><span class="PUNC">(</span><span class="NAME">currentDatas</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="COMM">//フレーム番号はスキップ配列にファイル名を登録</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">propName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentDatas</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/^#/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">currentDatas.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lyID</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">propName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentDatas</span><span class="PUNC">[</span><span class="NAME">lyID</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="COMM">//フレーム番号はスキップして</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">myTVP.frameOrigin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * @desc 取得したデータの構造は     *     * myTVP.layers[idx].Layers    >トラック名     * myTVP.layers[idx].Folder    >フルパス　要素配置フォルダ　＞MAP情報　MAP作成時にはグループ作成と同時にMAP書き出し     * myTVP.layers[idx].Density    >Float 0-1 不透明度     * myTVP.layers[idx].Blending    >String BlendingMode     * myTVP.layers[idx].Visible    >bool /表示     *     * ファイル名(1.0)    出力名.layers/Layer レイヤID/レイヤID_レイヤ名_フレームナンバ.拡張子 (インスタンス名サポート無し)     * ファイル名(1.1)    出力名.layers/[レイヤID] レイヤ名/[レイヤID][フレーム番号] インスタンス名又はレイヤ名.拡張子     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * 取得したデータから番号を生成する     * 新規のファイル名・エントリ対照オブジェクトを作る     * myTVP.layers.fileMap[idx]=new Object();     * レイヤ毎に処理     * エントリは[レイヤID,レイヤ名,フレームナンバを含むファイル名],[出現順ID,フレーム番号,インスタンス名]     *     * トレーラー配列     * @type {Array}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.layers.fileMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="NAME">this.LayerCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">//alert("|"+myTVP.csvVersion+"|");</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lidx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lidx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myTVP.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">lidx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fidx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">fidx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myTVP.FrameCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">fidx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">target</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">fidx</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myTVP.frameOrigin</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">switch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myTVP.csvVersion</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"CSV 1.0"</span><span class="PUNC">:</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">target</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">target.split</span><span class="PUNC">(</span><span class="STRN">"_"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">myTVP.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">target</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">myCount</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">myFrameNo</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">target.split</span><span class="PUNC">(</span><span class="STRN">"_"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">reverse</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">//			alert("lidx:"+[lidx]+":"+[target]+":"+[myCount,myTVP.layers[lidx].Layers+"-"+myFrameNo]);</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">myTVP.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">target</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">myCount</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myFrameNo</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="COMM">//フォーマット自体にインスタンス名のサポート無し</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">"CSV 1.1"</span><span class="PUNC">:</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">default</span><span class="PUNC">:</span><span class="WHIT"></span><span class="COMM">//		alert(target);</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">target</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">target.match</span><span class="PUNC">(</span><span class="REGX">/\[([0-9]+)\]\[([0-9]+)\]\s(.+)\.png/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">myTVP.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">target</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">myCount</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">myFrameNo</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">RegExp.$2</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">instanceName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">RegExp.$3</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">myTVP.layers</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Layers</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">""</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">RegExp.$3</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">myTVP.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">lidx</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">target</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">myCount</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myFrameNo</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">instanceName</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">//alert(JSON.stringify(myTVP.layers.fileMap[3]));</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * XPS互換ストリームに変換     * @returns {string}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.toSrcString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">batchStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shellStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">//	var myLineFeed=nas.GUI.LineFeed;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"\n"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"nasTIME-SHEET 0.4"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"#TVPaint"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"##TIME="</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">nas.Frm2FCT</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">this.FrameCount</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"##TRIN=0+00.,\x22\x22"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"##TROUT=0+00.,\x22\x22"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"##FRAME_RATE="</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.FrameRate</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">/**         * サイズ展開         * @type {string}         */</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[sizeX\t\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.Width</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"]"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[sizeY\t\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.Height</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"]"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[aspect\t\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">this.PixelAspectRatio</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"]"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">/**         * ラベル配置         * @type {string}         */</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[CELL\tN\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="COMM">//			resultStream	+=this.layerProps.Layers[this.LayerCount-idx-1]+"\t";</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers</span><span class="PUNC">[</span><span class="NAME">this.LayerCount</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Layers</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"]"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">frm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">frm</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.FrameCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">frm</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">/**             * TVPaint-csvはダイアログデータをサポートしないので1フィールドスキップ             * @type {string}             */</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.LayerCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">revTarget</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.LayerCount</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">frm</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.frameOrigin</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">this.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">frm</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.frameOrigin</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentKey</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentKey</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentKey</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">/*                 var currentValue=(typeof this.layers.fileMap[revTarget][currentKey] =="undefined")?                  this.layers[revTarget][frm+this.frameOrigin]:"X=X";                 (this.layers.fileMap[revTarget][currentKey][2])?this.layers.fileMap[revTarget][currentKey][2]:                 this.layers.fileMap[revTarget][currentKey][0];                 */</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentValue.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">match</span><span class="PUNC">(</span><span class="REGX">/\||\s/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="COMM">//シンボルクリア</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">currentKey</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentKey.match</span><span class="PUNC">(</span><span class="REGX">/.*\.png/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">/*-------------------------------------------バッチ生成*/</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">myGroupName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers</span><span class="PUNC">[</span><span class="NAME">this.LayerCount</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Layers</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">myFolderName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.layers</span><span class="PUNC">[</span><span class="NAME">this.LayerCount</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">Folder</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">//	alert(currentKey);</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">batchStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'ren "'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myFolderName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\\'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">currentKey</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'" "'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myFolderName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\\'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myGroupName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">nas.Zf</span><span class="PUNC">(</span><span class="NAME">this.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentKey</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'.png"\n'</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">shellStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'mv "'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myFolderName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'/'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">currentKey</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'" "'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myFolderName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'/'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myGroupName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">nas.Zf</span><span class="PUNC">(</span><span class="NAME">this.layers.fileMap</span><span class="PUNC">[</span><span class="NAME">revTarget</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currentKey</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'.png"\n'</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">/*-------------------------------------------*/</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"[END]"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myLineFeed</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">resultStream</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"converted from TVPaint:"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myTVP.csvVersion</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">/**         * @todo 超暫定版         * ファイル名を変更するバッチファイル　最初に書きだしたファイルを決め打ちするので         * ファイル移動後に実行した場合の結果は責任が持てない　暫定版なので勘弁ね         */</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">/*         resultStream	+="\nrem rename batch commnds\n\n";         resultStream	+=batchStream;         resultStream	+="\n\n#!/bin/sh\n\n";         resultStream	+=shellStream;         */</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">resultStream</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">// alert( myTVP.toSrcString());</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">myTVP.toSrcString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * 引数はオブジェクトでも、ストリームでも受け付ける。 * コンバートするXPSをTVP-csv互換形式で書き出す。 * 文字コードのコンバートは特にしていない * UTF外で書き出されることは無いはずだが、注意 * 逆変換は保留　21-04 2016 * * @param myXPS * @returns {*} * @constructor XPS2TVP(myXPS) */</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">XPS2TVP</span><span class="PUNC">(</span><span class="NAME">myXPS</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * 引数がソースであっても処理する。XPSでない場合はfalse     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myXPS</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Xps</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sourceXPS</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myXPS</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">myXPS</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">String</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myXPS.match</span><span class="PUNC">(</span><span class="REGX">/^nasTIME-SHEET/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sourceXPS</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Xps</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">sourceXPS.readIN</span><span class="PUNC">(</span><span class="NAME">myXPS</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * XPSフォーマット拡張に従ってタイミング以外のデータが発生するので、種別判定して選択する機能が必要     * プロパティをチェックして必要なタイムラインのIDを抽出する     * @type {Array}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myTargetId</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ix</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myXPS.layers.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ix</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myXPS.layers</span><span class="PUNC">[</span><span class="NAME">ix</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">option.match</span><span class="PUNC">(</span><span class="REGX">/(timing|still)/i</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">myTargetId.push</span><span class="PUNC">(</span><span class="NAME">ix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * コンバートする     * @type {Array}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myTVP</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.recordCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">26</span><span class="PUNC">;</span><span class="COMM">//TVPはレコード長固定</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * 第一レコードを作る     * @type {string}     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">defaultNames</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ct</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ct</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myTVP.recordCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ct</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ct</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myTargetId.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myXPS.layers</span><span class="PUNC">[</span><span class="NAME">myTargetId</span><span class="PUNC">[</span><span class="NAME">ct</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">defaultNames.charAt</span><span class="PUNC">(</span><span class="NAME">ct</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ct</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myTVP.recordCount</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.push</span><span class="PUNC">(</span><span class="NAME">currentRecord</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * 空レコードを挿入     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">myTVP.push</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="NUMB">26</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">"\t"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * 第二レコード以降ボディデータを流し込む(桁揃えで固定長レコードにする)     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">myFrame</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myXPS.duration</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">myFrame</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">LC</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">LC</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">myTVP.recordCount</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">LC</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">LC</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myXPS.layers.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">LC</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">myTargetId.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataCheck</span><span class="PUNC">(</span><span class="NAME">myXPS.xpsBody</span><span class="PUNC">[</span><span class="NAME">myTargetId</span><span class="PUNC">[</span><span class="NAME">LC</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">myFrame</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myXPS.layers</span><span class="PUNC">[</span><span class="NAME">myTargetId</span><span class="PUNC">[</span><span class="NAME">LC</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"blank"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"0"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">LC</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myTVP.recordCount</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">currentRecord</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"\t"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">//空フィールド</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">myTVP.push</span><span class="PUNC">(</span><span class="NAME">currentRecord</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">'"'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">myTVP.join</span><span class="PUNC">(</span><span class="STRN">"\r"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'"\r\n'</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * @todo 暫定的にXPSストリーム（ソース）で返しているが、オブジェクトのままのほうが良いかもしれない。一考の余地あり？ * この形式で各フォーマットのコンバータを作って一元化したいが、どうよ？ 逆変換も欲しいね。 */</span></pre></body></html>